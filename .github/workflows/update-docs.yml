name: Update Module README and Changelog

on:
  workflow_dispatch:
    inputs:
      module:
        description: 'Module to update (Use exact folder name inside repo)'
        required: true
      version:
        description: 'Version to set in README'
        required: true
      changelog_entry:
        description: 'Optional changelog entry'
        required: false

jobs:
  update-docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"

      - name: Generate README from template
        run: |
          MODULE="${{ github.event.inputs.module }}"
          VERSION="${{ github.event.inputs.version }}"
          TEMPLATE_FILE="../.github/templates/$MODULE/README.template.md"
          OUTPUT_FILE="$FOLDER/$MODULE/README.md"
          FOLDER = "Kidoz Direct"

          if [ ! -f "$TEMPLATE_FILE" ]; then
            echo "Template $TEMPLATE_FILE not found!"
            exit 1
          fi

          cp "$TEMPLATE_FILE" "$OUTPUT_FILE"
          sed -i "s/{{VERSION}}/$VERSION/g" "$OUTPUT_FILE"
          echo "Generated $OUTPUT_FILE from template."

      - name: Append changelog entry
        run: |
          MODULE="${{ github.event.inputs.module }}"
          VERSION="${{ github.event.inputs.version }}"
          CHANGELOG_FILE="$FOLDER/$MODULE/CHANGELOG.md"
          DATE=$(date +"%b %d, %Y")
          if [ -n "${{ github.event.inputs.changelog_entry }}" ]; then
            echo -e "## $VERSION - $DATE\n- $CHANGELOG_ENTRY\n" > /tmp/changelog.tmp
            cat "$CHANGELOG_FILE" >> /tmp/changelog.tmp
            mv /tmp/changelog.tmp "$CHANGELOG_FILE"
            echo "Changelog updated."
          else
            echo "No changelog entry provided; skipping."
          fi

      - name: Create branch
        run: |
          MODULE="${{ github.event.inputs.module }}"
          VERSION="${{ github.event.inputs.version }}"
          BRANCH_NAME="update_docs_${MODULE}_v${VERSION}"

          git checkout -b "$BRANCH_NAME"
          git add "$MODULE/README.md" "$MODULE/CHANGELOG.md"
          git commit -m "Update $MODULE README & changelog for $VERSION"
          git push origin "$BRANCH_NAME"
          echo "Branch $BRANCH_NAME pushed."

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          branch: "update_docs_${{ github.event.inputs.module }}_v${{ github.event.inputs.version }}"
          base: main
          title: "Update ${{ github.event.inputs.module }} README & changelog for ${{ github.event.inputs.version }}"
          body: |
            Automated update via GitHub Action.
            - Module: ${{ github.event.inputs.module }}
            - Version: ${{ github.event.inputs.version }}
            - Changelog: ${{ github.event.inputs.changelog_entry }}
