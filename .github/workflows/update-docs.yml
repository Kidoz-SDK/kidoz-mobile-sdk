name: Update Module README and Changelog

on:
    workflow_dispatch:
        inputs:
            os:
                description: "Platform (android/ios)"
                required: true
            version:
                description: "Version to set in README"
                required: true
            changelog_entry:
                description: "Optional changelog entry"
                required: false
            mediation:
                description: "Optional Adapter (admob, applovin, levelplay)"
                required: false

jobs:
    update-docs:
        runs-on: ubuntu-latest
        env:
            MEDIATION_FOLDER: "Mediation"
            CORE_FOLDER: "Kidoz Direct"
            mediation: |
                admob: AdMob Adapter
                applovin: AppLovin Max Adapter
                levelplay: IronSource LevelPlay Adapter
            os: |
                android: Android
                ios: iOS

        steps:
            - name: Validate inputs
              run: |
                  # Get inputs
                  OS_KEY="${{ github.event.inputs.os }}"
                  MEDIATION_KEY="${{ github.event.inputs.mediation }}"

                  # Check OS
                  if ! echo "$os" | awk -F': ' -v k="$OS_KEY" '$1==k {exit 0} END {exit 1}'; then
                  echo "Error: Invalid OS key '$OS_KEY'. Valid keys are: $(echo "$os" | awk -F': ' '{print $1}')"
                  exit 1
                  fi
                  echo "OS key '$OS_KEY' is valid."

                  # Check mediation only if provided
                  if [ -n "$MEDIATION_KEY" ]; then
                  if ! echo "$mediation" | awk -F': ' -v k="$MEDIATION_KEY" '$1==k {exit 0} END {exit 1}'; then
                      echo "Error: Invalid mediation key '$MEDIATION_KEY'. Valid keys are: $(echo "$mediation" | awk -F': ' '{print $1}')"
                      exit 1
                  fi
                  echo "Mediation key '$MEDIATION_KEY' is valid."
                  else
                  echo "No mediation key provided; skipping validation."
                  fi

            - name: Checkout repo
              uses: actions/checkout@v3

            - name: Set up Git
              run: |
                  git config user.name "GitHub Action"
                  git config user.email "action@github.com"

            - name: Generate README from template
              run: |
                  VERSION="${{ github.event.inputs.version }}"

                  KEY="${{ github.event.inputs.os }}"
                  OS_VALUE=$(echo "$os" | awk -F': ' -v k="$KEY" '$1==k {print $2}')
                  echo "Operating System=$OS_VALUE"

                  if [ -n "${{ github.event.inputs.mediation }}" ]; then
                    KEY="${{ github.event.inputs.mediation }}"
                    MEDIATION_VALUE=$(echo "$mediation" | awk -F': ' -v k="$KEY" '$1==k {print $2}')

                    TARGET_PATH="Mediation/$MEDIATION_VALUE/$OS_VALUE"
                  else
                    TARGET_PATH="Kidoz/$OS_VALUE"

                  echo "TARGET_PATH=$TARGET_PATH" >> $GITHUB_ENV
                  OUTPUT_FILE="$TARGET_PATH/README.md"
                  TEMPLATE_FILE="../.github/templates/$TARGET_PATH/README.template.md"

                  if [ ! -f "$TEMPLATE_FILE" ]; then
                    echo "Template $TEMPLATE_FILE not found!"
                    exit 1
                  fi

                  cp "$TEMPLATE_FILE" "$OUTPUT_FILE"
                  sed -i "s/{{VERSION}}/$VERSION/g" "$OUTPUT_FILE"
                  echo "Generated $OUTPUT_FILE from template."

            - name: Append changelog entry
              run: |
                  VERSION="${{ github.event.inputs.version }}"
                  CHANGELOG_FILE="$TARGET_PATH/CHANGELOG.md"
                  CHANGELOG_ENTRY="${{ github.event.inputs.changelog_entry }}"
                  DATE=$(date +"%b %d, %Y")
                  if [ -n "${{ github.event.inputs.changelog_entry }}" ]; then
                    echo -e "## $VERSION - $DATE\n- $CHANGELOG_ENTRY\n" > /tmp/changelog.tmp
                    cat "$CHANGELOG_FILE" >> /tmp/changelog.tmp
                    mv /tmp/changelog.tmp "$CHANGELOG_FILE"
                    echo "Changelog updated."
                  else
                    echo "No changelog entry provided; skipping."
                  fi

            - name: Create branch
              run: |
                  OS="${{ github.event.inputs.os }}"
                  VERSION="${{ github.event.inputs.version }}"

                  if [ -n "${{ github.event.inputs.mediation }}" ]; then
                    MEDIATION="${{ github.event.inputs.mediation }}"
                    BRANCH_NAME="update_docs_${MEDIATION}_${OS}_v${VERSION}"
                  else
                    BRANCH_NAME="update_docs_${OS}_v${VERSION}"
                  echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV

                  git checkout -b "$BRANCH_NAME"
                  git add "$TARGET_PATH/README.md" "$TARGET_PATH/CHANGELOG.md"
                  git commit -m "Update $TARGET_PATH README & changelog for $VERSION"
                  git push origin "$BRANCH_NAME"
                  echo "Branch $BRANCH_NAME pushed."

            - name: Create Pull Request
              uses: peter-evans/create-pull-request@v5
              with:
                  branch: "$BRANCH_NAME"
                  base: update_docs_action
                  title: "Update $TARGET_PATH README & changelog for ${{ github.event.inputs.version }}"
                  body: |
                      Automated update via GitHub Action.
                      - Updated: $TARGET_PATH
                      - Version: ${{ github.event.inputs.version }}
                      - Changelog: ${{ github.event.inputs.changelog_entry }}
